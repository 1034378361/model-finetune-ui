name: Deploy to Streamlit Cloud

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
    
    - name: Run tests
      run: |
        # å½“æœ‰æµ‹è¯•æ–‡ä»¶æ—¶è¿è¡Œ
        # pytest tests/ --cov=. --cov-report=xml
        echo "æµ‹è¯•é€šè¿‡ - å¾…æ·»åŠ å…·ä½“æµ‹è¯•ç”¨ä¾‹"
    
    - name: Lint with ruff
      run: |
        pip install ruff
        ruff check . --output-format=github
    
    - name: Check code formatting
      run: |
        pip install black
        black --check .

  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run security scan
      run: |
        pip install safety bandit
        safety check -r requirements.txt
        bandit -r . -x tests/

  validate-config:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Validate configuration
      run: |
        # æ£€æŸ¥å¿…è¦æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        test -f app.py || exit 1
        test -f requirements.txt || exit 1
        test -f .streamlit/config.toml || exit 1
        echo "é…ç½®æ–‡ä»¶éªŒè¯é€šè¿‡"

  deploy-info:
    runs-on: ubuntu-latest
    needs: [test, security-scan, validate-config]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Deployment Ready
      run: |
        echo "ğŸš€ é¡¹ç›®å·²å‡†å¤‡å¥½éƒ¨ç½²åˆ° Streamlit Cloud"
        echo "è¯·åœ¨ Streamlit Cloud æ§åˆ¶å°ä¸­è¿æ¥æ­¤ä»“åº“"