name: Deploy to Streamlit Cloud

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
    
    - name: Run tests
      run: |
        # 当有测试文件时运行
        # pytest tests/ --cov=. --cov-report=xml
        echo "测试通过 - 待添加具体测试用例"
    
    - name: Lint with ruff
      run: |
        pip install ruff
        ruff check . --output-format=github
    
    - name: Check code formatting
      run: |
        pip install black
        black --check .

  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run security scan
      run: |
        pip install safety bandit
        safety check -r requirements.txt
        bandit -r . -x tests/

  validate-config:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Validate configuration
      run: |
        # 检查必要文件是否存在
        test -f app.py || exit 1
        test -f requirements.txt || exit 1
        test -f .streamlit/config.toml || exit 1
        echo "配置文件验证通过"

  deploy-info:
    runs-on: ubuntu-latest
    needs: [test, security-scan, validate-config]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Deployment Ready
      run: |
        echo "🚀 项目已准备好部署到 Streamlit Cloud"
        echo "请在 Streamlit Cloud 控制台中连接此仓库"